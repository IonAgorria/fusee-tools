#include "common.h"
#include "bootrom_usb_helper.h"
#include "strings.h"
#include "memory.h"
#include "pmc_reset.h"

static char tmpstrbufa[0x800];
static char tmpstrbuf[0x1000];

#define tegra_aes_dbg(dd, ...) \
    memset(tmpstrbufa, 0, 0x800); \
    memset(tmpstrbuf, 0, 0x1000); \
    sprintf(tmpstrbufa, __VA_ARGS__); \
    sprintf(tmpstrbuf, "tegra_aes_dbg(%p) %s\n", dd, tmpstrbufa); \
    usb_transfer_data(tmpstrbuf, strlen(tmpstrbuf));

#include "tegra-aes.h"

void main() {
	char str[] = "Hello, this is a message over USB :)";
    usb_transfer_data(str, strlen(str));
    
    uint8_t* base_ptr = (uint8_t*) 0x40020000;

    struct tegra_aes_dev* dd = (struct tegra_aes_dev*) base_ptr;
    const uint32_t data_len = 0x100;
    uint8_t* data_in = base_ptr + 0x200;
    uint8_t* data_out = data_in + data_len;
    
    dd->io_base = (uint8_t*) TEGRA_VDE_BASE;
    dd->keylen = 16;
    tegra_aes_init(dd);
    tegra_aes_select_key_slot(dd, TEGRA_AES_SBK_SLOT_NUM);
    tegra_aes_enable_icmdqen(dd);

    *(uint32_t*) data_in = 0xDEADBEEF;
    memset(data_in, 0, data_len);

    /*
tegra_aes_copy_to_vram(dd, data_in, data_len / sizeof(uint32_t));

memset(data_out, 0, data_len);
tegra_aes_copy_from_vram(dd, data_out, data_len / sizeof(uint32_t));
usb_transfer_data(data_out, data_len);
    */

    //tegra_aes_clear_vram(dd);
    tegra_aes_test(dd, data_in, data_len / sizeof(uint32_t));
    usb_transfer_data(data_in, data_len);

    memset(data_out, 0, data_len);
    tegra_aes_start_crypt(dd, data_in, data_out, 1, FLAGS_ENCRYPT | FLAGS_CBC, 1);

    usb_transfer_data(data_out, data_len);

    /*
    usb_transfer_data(data_in, data_len);
    tegra_aes_copy_to_vram(dd, data_in, data_len / sizeof(uint32_t));
    
    memset(data_out, 0, data_len);
    tegra_aes_copy_from_vram(dd, data_out, data_len / sizeof(uint32_t));
    usb_transfer_data(data_out, data_len);
    
    */
    pmc_reset_rcm();
}
